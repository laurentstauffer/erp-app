<div class="project-detail-page">
  <div class="header">
    <h2>{{ isEditMode ? 'Modifier le projet' : 'Nouveau projet' }}</h2>
    <button class="btn-secondary" (click)="cancel()">
      ‚Üê Retour √† la liste
    </button>
  </div>

  <div class="error-message" *ngIf="errorMessage">
    {{ errorMessage }}
  </div>

  <div class="content" *ngIf="!isLoading">
    <div class="section">
      <h3>Informations du projet</h3>
      <form [formGroup]="projectForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="name">Nom du projet *</label>
            <input 
              id="name" 
              type="text" 
              formControlName="name"
              placeholder="Entrez le nom du projet"
              [class.error]="name?.invalid && name?.touched">
            <div *ngIf="name?.invalid && name?.touched" class="error-message">
              <small *ngIf="name?.errors?.['required']">Le nom est requis</small>
              <small *ngIf="name?.errors?.['minlength']">Le nom doit contenir au moins 3 caract√®res</small>
            </div>
          </div>

          <div class="form-group full-width">
            <label for="description">Description *</label>
            <textarea 
              id="description" 
              formControlName="description"
              placeholder="Entrez la description du projet"
              rows="3"
              [class.error]="description?.invalid && description?.touched"></textarea>
            <div *ngIf="description?.invalid && description?.touched" class="error-message">
              <small *ngIf="description?.errors?.['required']">La description est requise</small>
            </div>
          </div>

          <div class="form-group">
            <label for="startDate">Date de d√©but *</label>
            <input 
              id="startDate" 
              type="date" 
              formControlName="startDate"
              [class.error]="startDate?.invalid && startDate?.touched">
            <div *ngIf="startDate?.invalid && startDate?.touched" class="error-message">
              <small *ngIf="startDate?.errors?.['required']">La date de d√©but est requise</small>
            </div>
          </div>

          <div class="form-group">
            <label for="endDate">Date de fin *</label>
            <input 
              id="endDate" 
              type="date" 
              formControlName="endDate"
              [class.error]="endDate?.invalid && endDate?.touched">
            <div *ngIf="endDate?.invalid && endDate?.touched" class="error-message">
              <small *ngIf="endDate?.errors?.['required']">La date de fin est requise</small>
            </div>
          </div>
        </div>
      </form>
    </div>

    <div class="section">
      <h3>T√¢ches du projet</h3>
      
      <div class="task-form">
        <h4>{{ editingTaskIndex !== null ? 'Modifier la t√¢che' : 'Ajouter une t√¢che' }}</h4>
        <form [formGroup]="taskForm">
          <div class="form-grid">
            <div class="form-group">
              <label for="taskName">Nom de la t√¢che *</label>
              <input 
                id="taskName" 
                type="text" 
                formControlName="name"
                placeholder="Nom de la t√¢che"
                [class.error]="taskName?.invalid && taskName?.touched">
              <div *ngIf="taskName?.invalid && taskName?.touched" class="error-message">
                <small *ngIf="taskName?.errors?.['required']">Le nom est requis</small>
                <small *ngIf="taskName?.errors?.['minlength']">Le nom doit contenir au moins 3 caract√®res</small>
              </div>
            </div>

            <div class="form-group">
              <label for="taskDuration">Dur√©e (jours) *</label>
              <input 
                id="taskDuration" 
                type="number" 
                formControlName="duration"
                min="1"
                [class.error]="taskDuration?.invalid && taskDuration?.touched">
              <div *ngIf="taskDuration?.invalid && taskDuration?.touched" class="error-message">
                <small *ngIf="taskDuration?.errors?.['required']">La dur√©e est requise</small>
                <small *ngIf="taskDuration?.errors?.['min']">La dur√©e doit √™tre d'au moins 1 jour</small>
              </div>
            </div>

            <div class="form-group">
              <label for="taskStatus">Statut</label>
              <select id="taskStatus" formControlName="status">
                <option value="TODO">√Ä faire</option>
                <option value="IN_PROGRESS">En cours</option>
                <option value="BLOCKED">Bloqu√©e</option>
                <option value="COMPLETED">Termin√©e</option>
              </select>
            </div>

            <div class="form-group">
              <label for="taskProgress">Avancement : {{ taskForm.get('progress')?.value || 0 }}%</label>
              <input 
                id="taskProgress" 
                type="range" 
                formControlName="progress"
                min="0"
                max="100"
                step="5"
                class="progress-slider">
            </div>

            <div class="form-group">
              <label for="taskPredecessors">D√©pendances (t√¢ches pr√©d√©cesseurs)</label>
              <select 
                id="taskPredecessors" 
                formControlName="predecessorIds"
                multiple
                size="3">
                <option *ngFor="let task of getAvailablePredecessors()" [value]="task.id">
                  {{ task.name }}
                </option>
              </select>
              <small class="help-text">Maintenez Ctrl (Cmd sur Mac) pour s√©lectionner plusieurs</small>
            </div>

            <div class="form-group">
              <label for="taskAssignees">Ressources (utilisateurs assign√©s)</label>
              <select 
                id="taskAssignees" 
                formControlName="assigneeIds"
                multiple
                size="3">
                <option *ngFor="let user of users" [value]="user.id">
                  {{ user.username }}
                </option>
              </select>
              <small class="help-text">Maintenez Ctrl (Cmd sur Mac) pour s√©lectionner plusieurs</small>
            </div>

            <div class="form-group">
              <label for="taskStartDate">Date de d√©but (auto-calcul√©e)</label>
              <input 
                id="taskStartDate" 
                type="date" 
                formControlName="startDate"
                readonly
                placeholder="Calcul√©e automatiquement">
            </div>

            <div class="form-group">
              <label for="taskDueDate">Date d'√©ch√©ance (auto-calcul√©e)</label>
              <input 
                id="taskDueDate" 
                type="date" 
                formControlName="dueDate"
                readonly
                placeholder="Calcul√©e automatiquement">
            </div>
          </div>
          <div class="task-form-actions">
            <button type="button" class="btn-add" (click)="addTask()" [disabled]="taskForm.invalid">
              {{ editingTaskIndex !== null ? 'Mettre √† jour' : '+ Ajouter la t√¢che' }}
            </button>
            <button type="button" class="btn-cancel" *ngIf="editingTaskIndex !== null" (click)="cancelEdit()">
              Annuler
            </button>
          </div>
        </form>
      </div>

      <div class="tasks-list" *ngIf="project.tasks && project.tasks.length > 0">
        <h4>T√¢ches ajout√©es ({{ project.tasks.length }})</h4>
        <div class="recalculate-section">
          <button class="btn-recalculate" (click)="recalculateDates()" *ngIf="isEditMode">
            üîÑ Recalculer les dates
          </button>
        </div>
        <table class="tasks-table">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Dur√©e</th>
              <th>D√©but</th>
              <th>√âch√©ance</th>
              <th>Statut</th>
              <th>Avancement</th>
              <th>D√©pendances</th>
              <th>Assign√©s</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let task of project.tasks; let i = index">
              <td>{{ task.name }}</td>
              <td>{{ task.duration }} jour{{ task.duration > 1 ? 's' : '' }}</td>
              <td>{{ task.startDate ? (task.startDate | date:'dd/MM/yyyy') : '-' }}</td>
              <td>{{ task.dueDate ? (task.dueDate | date:'dd/MM/yyyy') : '-' }}</td>
              <td>
                <span class="status-badge" [class]="getStatusClass(task.status || 'TODO')">
                  {{ getStatusLabel(task.status || 'TODO') }}
                </span>
              </td>
              <td>
                <div class="progress-container">
                  <div class="progress-bar">
                    <div class="progress-fill" [style.width.%]="task.progress || 0"></div>
                  </div>
                  <span class="progress-text">{{ task.progress || 0 }}%</span>
                </div>
              </td>
              <td>
                <span class="dependencies" *ngIf="task.predecessorIds && task.predecessorIds.length > 0">
                  {{ getPredecessorNames(task.predecessorIds).join(', ') }}
                </span>
                <span class="no-dependencies" *ngIf="!task.predecessorIds || task.predecessorIds.length === 0">
                  Aucune
                </span>
              </td>
              <td>
                <span class="assignees" *ngIf="task.assigneeIds && task.assigneeIds.length > 0">
                  üë§ {{ getAssigneeNames(task.assigneeIds).join(', ') }}
                </span>
                <span class="no-assignees" *ngIf="!task.assigneeIds || task.assigneeIds.length === 0">
                  Non assign√©e
                </span>
              </td>
              <td class="task-actions">
                <button class="btn-edit-small" (click)="editTask(i)" title="Modifier">
                  ‚úèÔ∏è
                </button>
                <button class="btn-delete-small" (click)="removeTask(i)" title="Supprimer">
                  üóëÔ∏è
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <p class="no-tasks" *ngIf="!project.tasks || project.tasks.length === 0">
        Aucune t√¢che ajout√©e pour le moment
      </p>
    </div>

    <div class="actions-footer">
      <button class="btn-secondary" (click)="cancel()">Annuler</button>
      <button class="btn-primary" (click)="saveProject()" [disabled]="isLoading">
        {{ isEditMode ? 'Mettre √† jour' : 'Cr√©er' }}
      </button>
    </div>
  </div>

  <div class="loading" *ngIf="isLoading">
    Chargement...
  </div>
</div>
